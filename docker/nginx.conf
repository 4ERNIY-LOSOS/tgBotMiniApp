server {
    listen 80;

    # Общие настройки логов
    error_log /log/error.log;
    access_log /log/access.log;

    # --- Обслуживание Mini App ---
    location /mini_app {
        alias /var/www/html/mini_app_public; # Путь к статическим файлам Mini App
        index index.html index.htm;
        try_files $uri $uri/ /mini_app/index.html; # Если файл не найден, отдать index.html Mini App
    }

    # --- Обслуживание Telegram бота ---
    location = /telegram_bot_php/bot.php {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000; # Имя PHP-FPM сервиса из docker-compose
        fastcgi_index bot.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # --- Обслуживание HLEB Framework (API и основной сайт) ---
    # Корень для HLEB
    root /var/www/html/hleb/public;
    index index.php;

    location / {
        # Сначала пытаемся отдать статический файл, потом директорию, потом передаем на HLEB
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        # Этот блок будет обрабатывать HLEB (hleb/public/index.php)
        # и любые другие PHP файлы, если они есть в hleb/public (хотя обычно все идет через index.php)
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000; # Имя PHP-FPM сервиса
        # SCRIPT_FILENAME должен указывать на hleb/public/index.php для HLEB
        # Для HLEB все запросы к PHP должны идти через его главный index.php
        fastcgi_param SCRIPT_FILENAME /var/www/html/hleb/public/index.php;
        include fastcgi_params;
    }

    # Запрет доступа к .htaccess и другим скрытым файлам
    location ~ /\. {
        deny all;
    }
}
